[tools]
node = "lts"
pnpm = "10.28.0"
go = "1.24"
buf = "latest"

# --- Frontend ---
[tasks.dev]
description = "Start frontend dev server"
run = "pnpm run dev"
dir = "frontend"

[tasks.lint]
description = "Lint frontend code"
run = "pnpm run lint"
dir = "frontend"

[tasks.format]
description = "Format frontend code"
run = "pnpm run format"
dir = "frontend"

[tasks.install]
description = "Install frontend dependencies"
run = "pnpm install"
dir = "frontend"

# --- Backend ---
[tasks."go:dev"]
description = "Start backend dev server"
run = "go run ./cmd/server"
dir = "backend"

[tasks."go:build"]
description = "Build backend binary"
run = "go build -o bin/server ./cmd/server"
dir = "backend"

[tasks."go:test"]
description = "Run backend tests"
run = "go test ./..."
dir = "backend"

[tasks."go:tidy"]
description = "Tidy backend dependencies"
run = "go mod tidy"
dir = "backend"

# --- Proto ---
[tasks."proto:gen"]
description = "Generate code from proto files"
run = "buf generate"

[tasks."proto:lint"]
description = "Lint proto files"
run = "buf lint"

[tasks."proto:format"]
description = "Format proto files"
run = "buf format -w"

# --- Build ---
[tasks."build:frontend"]
description = "Build frontend for production"
run = "pnpm run build"
dir = "frontend"

[tasks."build:embed"]
description = "Copy frontend build to backend"
run = "rm -rf backend/cmd/server/web && cp -r frontend/dist backend/cmd/server/web"
depends = ["build:frontend"]

[tasks."build:backend"]
description = "Build backend for production"
run = "go build -o bin/server ./cmd/server"
dir = "backend"
depends = ["build:embed"]

[tasks.build]
description = "Build everything for production"
depends = ["proto:gen", "build:backend"]

# --- Clean ---
[tasks.clean]
description = "Clean all generated files"
run = "rm -rf frontend/dist backend/bin backend/cmd/server/web frontend/src/gen/proto backend/gen/proto"

#############################################################################

[tasks.setup]
depends = [
  "config",
  "voltagent",
  "setup:cgc",
  "setup:demongrep",
]

[tasks.config]
run = """
cp .claude/config/mise.toml mise.toml
cp .claude/config/mcp.docker-compose.yml mcp.docker-compose.yml
"""

[tasks."setup:demongrep"]
run = """
mkdir -p ~/.local/share/claude-setup
cd ~/.local/share/claude-setup
git clone https://github.com/yxanul/demongrep.git || true
cd demongrep
git pull
mise exec rust@1.93.0 -- cargo build --release
"""

[tasks."setup:cgc"]
run = [
  "mise exec python@3.14.2 -- pip install codegraphcontext",
]

[tasks."voltagent"]
run = """
claude plugin marketplace add VoltAgent/awesome-claude-code-subagents || true
claude plugin install voltagent-core-dev
claude plugin install voltagent-lang
claude plugin install voltagent-infra
claude plugin install voltagent-qa-sec
claude plugin install voltagent-data-ai
claude plugin install voltagent-dev-exp
claude plugin install voltagent-domains
claude plugin install voltagent-biz
claude plugin install voltagent-meta
claude plugin install voltagent-research
"""

[tasks.docker]
run = "docker compose -f mcp.docker-compose.yml up -d"

[tasks.mcps]
depends = [
  "cgcwatch",
  "demongrepwatch",
]

[tasks.cgcwatch]
run = [
  "./.claude/scripts/fix-cgc-optimizations.sh",
  { task = "cgc index ." },
  { task = "cgc watch ." },
]

[tasks.demongrepwatch]
run = [
  { task = "demongrep index ." },
  { task = "demongrep serve ." },
]

[tasks.cgc]
env.NEO4J_URI = "neo4j://localhost:7687"
env.NEO4J_USERNAME = "neo4j"
env.NEO4J_PASSWORD = "password"
env.DEFAULT_DATABASE = "neo4j"
run = "mise exec python@3.14.2 -- cgc"

[tasks.demongrep]
run = "~/.local/share/claude-setup/demongrep/target/release/demongrep"
